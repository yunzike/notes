## 一、项目简介

![谷粒商城-微服务架构图](../images/谷粒商城-微服务架构图.jpg)



注册中心、配置中心：Nacos

远程调用：Feign

网关：SpringCloud Gateway

阿里巴巴的Sentinel：熔断降级

OAuth2.0 认证中心：登录，权限控制：Spring Security

链路追踪：Sleuth、Zipkin

Redis集群、MySQL的主从分片、RabbitMQ、ES（ElasticSearch）的全文检索



布署一个K8S集群





## 二、分布式概念

#### 1、微服务

微服务架构风格，就像是把一个单独的应用程序开发为一套小服务，每个小服务运行在自己的进程中，并使用轻量级机制通信，通常是HTTP APl。这些服务围绕业务能力来构建，并通过完全自动化部署机制来独立部署。这些服务使用不同的编程语言书写，以及不同数据存储技术，共促持最低限度的集中式管理。
简而言之，拒绝大型单体应用，基于业务边界进行服务微化拆分，各个服务独立部署运行。

#### 2、集群&分布式&节点

- 集群

  只要是一堆机器，就可以叫集群，他们是不是一起协作着干活，这个谁也不知道；

- 分布式

  《分布式系统原理与范型》定义：
  “分布式系统是若干独立计算机的集合，这些计算机对于用户来说就像单个相关系统”
  分布式系统（distributed system）是建立在网络之上的软件系统。

- 节点

  集群中的一个服务器。

集群是个物理形态，分布式是个工作方式。分布式是指将不同的业务分布在不同的地方，集群指的是将几台服务器集中在一起，实现同一业务。

例如：京东是一个分布式系统，众多业务运行在不同的机器，所有业务构成一个大型的业务集群。每一个小的业务，比如用户系统，访问压力大的时候一台服务器是不够的。我们就应该将用户系统部署到多个服务器，也就是每一个业务系统也可以做集群化；

分布式中的每一个节点都可以做集群。而集群并不一定就是分布式的。

#### 3、远程调用

在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的需要互相调用，我们称为远程调用。

SpringCloud中使用HTTP + JSON的方式完成远程调用



#### 4、负载均衡

某个服务在多台服务器中都存在，调用任意一台都可以调用这个服务完成功能时，为了使每个服务器都不要太忙或者太闲，可以负载均衡的调用每一个服务器。

常见的负载均衡算法：

轮询：依次调用

最小连接：优先选择连接数最少的服务器，也就是压力最小的后端服务器。在会话比较长的情况下可以考虑采用这种方式。

散列：根据请求源的IP的散列（hash）来选择要转发的服务器。这种方式可以在一定程度上保证特定用户能连接到相同的服务器。

#### 5、服务注册/发现&注册中心

服务注册：服务上线时注册到注册中心，则注册中心可以知道每个服务在那个服务器上是可用的，或者是下线的。

发现：服务间的调用时，通过注册中心，去发现要调用的服务在哪台机器上是注册的，从而避免调用已经下线的服务。

#### 6、配置中心

每一个服务最终都有大量的配置，并且每个服务都可能部署在多台机器上。我们经常需要变更配置，我们可以让每个服务在配置中心获取自己的配置。
**配置中心用来集中管理微服务的配置信息。**

#### 7、服务熔断&服务降级

- **雪崩效应**

  在微服务架构中，微服务之间通过网络进行通信，存在相互依赖，当其中一个服务不可用时，有可能会造成**雪崩效应**。比如：下单时，订单服务调用商品服务，商品服务调用库存服务查询是否有库存，此时如果库存服务出现故障导致响应慢，商品服务就得等待，也就是说库存服务的不可用就会导致商品服务的阻塞，在商品服务的等待期间，订单服务也会阻塞。最终一个服务的不可用就会导致整个服务调用链一直阻塞。如果是高并发的请求，多个请求都阻塞了导致请求挤压，最终会导致整个服务器的资源耗尽。要防止这样的情况，必须要有容错机制来保护服务。

- **服务熔断**

  设置服务的超时，当被调用的服务经常失败到达某个阈值，我们可以开启断路保护机制，后来的请求不再去调用这个服务。本地直接返回默认的数据

- **服务降级**：

  在运维期间，当系统处于高峰期，系统资源紧张，我们可以让非核心业务降级运行。降级：某些服务不处理，或者简单处理【抛异常、返回NULL、调用Mock数据、调用Fallback处理逻辑】。

#### 8、API网关

在微服务架构中，API Gateway作为整体架构的重要组件，它**抽象了微服务中都需要的公共功能**，同时提供了**客户端负载均衡**，**服务自动熔断**，**灰度发布**，**统一认证**，**限流流控**，**日志统计**等丰富的功能，帮助我们解决很多API管理难题。



## 三、环境搭建

#### 1、安装Linux虚拟机

- 下载安装Virtual Box

  官网下载VirtualBox https://www.virtualbox.org/
  安装前要开启CPU虚拟化，即在BIOS的设置里要把Intel Virtualization Technolgy设置为Enabled

- 使用Vagrant在Virtual Box中安装CenterOS

  ①下载&安装Vagrant

  https://www.vagrantup.com/downloads.html Vagrant 下载
  https://app.vagrantup.com/boxes/search Vagrant 官方镜像仓库

  ②安装centos

  打开window cmd窗口，运行 Vagrant init centos/7，即可初始化一个centos7系统，运行vagrant up即可启动虚拟机。
  系统root用户的密码是vagrant

  ③vagrant其他常用命令

  vagrant ssh：自动使用vagrant用户连接虚拟机。
  vagrant reload：重启虚拟机
  vagrant upload source[destination][namelid]：上传文件
  https://www.vagrantup.com/docs/cli/init.html Vagrant 命令行文档

  ④修改虚拟机的IP地址

  默认虚拟机的ip地址不是固定ip，访问虚拟机的MySQL等软件需要在Virtual Box中设置端口转发，开发不方便。
  可以通过修改Vagrantfile文件来修改虚拟机的IP地址

  ```bash
  # Vagrantfile 文件位于用户的根目录下
  # 其中ip地址，必须和主机 VirtualBox Host-Only Network 的IP地址（如：192.168.56.1）的前三个部分保持相同
  config.vm.network "private_network", ip: "192.168.56.10"
  ```

#### 2、安装Docker







